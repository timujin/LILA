[gd_scene load_steps=2 format=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

#####################
## ROOM PARAMETERS ##
#####################
# PATH TO ROOM -> PARAMETER -> VALUE
# Ideally this is a part of what gets saved to the savefile
var roomsParameters:Dictionary = {}

func initialize_room_values(path:String)->void:
	if not roomsParameters.has(path):
		roomsParameters[path] = load_room_params(path)
	else:
		pass
	
func set_room_value(path:String, key:String, value):
	initialize_room_values(path)
	roomsParameters[path][key] = value

func get_room_value(path:String, key:String, default):
	initialize_room_values(path)
	if roomsParameters.has(path) and roomsParameters[path].has(key):
		return roomsParameters[path][key]
	else:
		return default
		
func load_room_params(path:String)->Dictionary:
	return load(path).new().get_default_parameters()

#####################
## ROOM LOADING #####
#####################

onready var player = preload(\"res://Objects/TheSpirit/TheSpirit.tscn\")
var destination_spawnpoint:String = \"\"

var room:Node2D = null

func on_room_loaded():
	print(\"Loaded room: \" + str(room))
	if room.get_contains_player():
		var destination
		if destination_spawnpoint == \"\":
			destination = get_node(\"/root/Room/Geometry/\"+\"DefaultSpiritSpawn\")
		else:
			destination = get_node(\"/root/Room/Geometry/\"+destination_spawnpoint)
		if destination == null:
			printerr(\"Spawn point not found: \" + destination_spawnpoint)
		else:
			spawn_player(destination)
	
func switch_room(to_room:PackedScene, destination=\"\"):
	destination_spawnpoint = destination
	$\"/root/Room\".name = \"Todelete_room\"
	$\"/root/Todelete_room\".queue_free()
	room = to_room.instance()
	get_tree().get_root().add_child(room)
	
# TODO: switch room by name
	
func load_room(path:String):
	var fullpath = \"res://Locations/\" + path + \".tscn\"
	return load(fullpath)
	
func switch_room_by_path(path:String, destination=\"\"):
	var room = load_room(path)
	if room == null:
		$\"/root/DeveloperConsole\".echo(\"!!! Room not found!: \" + path)
	else:
		switch_room(room, destination)
	
	
func spawn_player(at:Node2D):
	var p = player.instance()
	room.add_child(p)
	p.position = at.position
	"

[node name="RoomSwitcher" type="Node2D"]
script = SubResource( 1 )
